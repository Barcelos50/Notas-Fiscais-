// Processar imagem da c√¢mera (m√©todo alternativo)
        function processarImagem(input) {
            const file = input.files[0];
            if (!file) return;

            updateStatus('üì∏ Foto capturada! Analisando com IA...', true);
            
            // Usar Html5Qrcode para analisar arquivo
            const html5QrCode = new Html5Qrcode("temp-reader");
            
            html5QrCode.scanFile(file, true)
                .then(decodedText => {
                    // QR Code detectado com sucesso
                    updateStatus('‚úÖ QR Code detectado na imagem!');
                    
                    const dados = processarQRReal(decodedText);
                    preencherFormulario(dados);
                    
                    updateStatus(`üéâ Sucesso! ${dados.estabelecimento} - R$ ${dados.valor}`);
                    
                    // Scroll para formul√°rio
                    document.querySelector('.form-section').scrollIntoView({ 
                        behavior: 'smooth' 
                    });
                    
                    vibrar([100, 50, 100]);
                })
                .catch(err => {
                    // Fallback para simula√ß√£o se n√£o conseguir ler
                    console.log('QR n√£o detectado na imagem, usando simula√ß√£o:', err);
                    
                    setTimeout(() => {
                        const dados = simularLeituraQR();
                        preencherFormulario(dados);
                        
                        updateStatus(`ü§ñ Imagem processada: ${dados.estabelecimento} (simula√ß√£o)`);
                        
                        document.querySelector('.form-section').scrollIntoView({ 
                            behavior: 'smooth' 
                        });
                        
                        vibrar([100, 50, 100]);
                    }, 1500);
                });
        }<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Controle NF">
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==">
    <title>üì± Controle de Notas Fiscais</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #4CAF50;
            --primary-dark: #45a049;
            --secondary: #2196F3;
            --danger: #f44336;
            --warning: #FF9800;
            --success: #4CAF50;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-shadow: 0 10px 30px rgba(0,0,0,0.15);
            --border-radius: 20px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--background);
            min-height: 100vh;
            padding: 15px;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius);
            padding: 0;
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }
        
        .header {
            text-align: center;
            padding: 40px 30px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }
        
        .header-content {
            position: relative;
            z-index: 2;
        }
        
        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
            font-weight: 300;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .feature-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .feature-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .feature-card:hover::before {
            left: 100%;
        }
        
        .feature-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }
        
        .feature-card h3 {
            margin-bottom: 15px;
            font-size: 1.4rem;
            font-weight: 600;
        }
        
        .feature-card p {
            margin-bottom: 20px;
            opacity: 0.9;
            line-height: 1.5;
        }
        
        .camera-section {
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
        }
        
        .quick-add-section {
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
        }
        
        .stats-section {
            background: linear-gradient(135deg, #A8EDEA, #FED6E3);
            color: var(--dark);
        }
        
        .btn {
            background: rgba(255,255,255,0.9);
            color: inherit;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin: 8px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: var(--transition);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #c62828);
            color: white;
        }
        
        .btn-small {
            padding: 10px 20px;
            font-size: 14px;
            width: auto;
            margin: 0 5px;
        }
        
        .form-section {
            background: rgba(248,249,250,0.8);
            padding: 30px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            backdrop-filter: blur(10px);
        }
        
        .form-section h3 {
            margin-bottom: 25px;
            color: var(--dark);
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        input, select {
            padding: 16px;
            border: 2px solid rgba(0,0,0,0.1);
            border-radius: 12px;
            font-size: 16px;
            background: rgba(255,255,255,0.9);
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(76,175,80,0.1);
            transform: translateY(-2px);
            background: white;
        }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            padding: 25px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .summary-card:hover {
            transform: scale(1.05) translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .summary-card h3 {
            font-size: 0.9rem;
            margin-bottom: 10px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--dark);
            font-weight: 500;
        }
        
        .summary-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary);
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
            padding: 25px;
            background: rgba(248,249,250,0.6);
            border-radius: var(--border-radius);
            backdrop-filter: blur(10px);
        }
        
        .notes-list {
            margin-top: 20px;
        }
        
        .notes-list h3 {
            margin-bottom: 20px;
            color: var(--dark);
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .note-item {
            background: rgba(255,255,255,0.9);
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid var(--primary);
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            backdrop-filter: blur(20px);
        }
        
        .note-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.12);
            border-left-color: var(--secondary);
        }
        
        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .note-info h4 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .note-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 0.9rem;
            color: rgba(0,0,0,0.6);
            margin-bottom: 12px;
        }
        
        .note-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--secondary);
            margin-top: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(0,0,0,0.5);
            background: rgba(248,249,250,0.5);
            border-radius: var(--border-radius);
            border: 2px dashed rgba(0,0,0,0.1);
        }
        
        .status-bar {
            background: linear-gradient(135deg, #00C851, #00A041);
            color: white;
            padding: 16px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(10px);
        }
        
        .processing-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
            }
        }
        
        .quick-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .quick-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 15px 12px;
            border: none;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .quick-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        #qr-reader {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 3px solid rgba(255,255,255,0.3);
        }
        
        .api-status {
            margin-top: 15px;
            padding: 12px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            font-size: 12px;
            border: 1px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(10px);
        }
        
        @media (max-width: 600px) {
            .container { 
                margin: 5px;
                border-radius: 15px;
            }
            .header {
                padding: 30px 20px;
            }
            .header h1 { 
                font-size: 1.8rem; 
            }
            .main-content {
                padding: 20px;
            }
            .feature-cards { 
                grid-template-columns: 1fr; 
            }
            .summary { 
                grid-template-columns: repeat(2, 1fr); 
            }
            .filters { 
                grid-template-columns: 1fr; 
            }
            .form-grid { 
                grid-template-columns: 1fr; 
            }
            .quick-buttons { 
                grid-template-columns: repeat(2, 1fr); 
            }
        }
        
        .hidden { 
            display: none !important; 
        }
        
        /* PWA Styles */
        @media (display-mode: standalone) {
            body {
                user-select: none;
                -webkit-user-select: none;
                padding-top: 20px;
            }
        }
        
        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
            .header h1 { font-size: 1.8rem; }
            .feature-cards { grid-template-columns: 1fr; }
            .summary { grid-template-columns: repeat(2, 1fr); }
            .filters { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .quick-buttons { grid-template-columns: repeat(2, 1fr); }
        }
        
        .hidden { display: none !important; }
        
        /* PWA Styles */
        @media (display-mode: standalone) {
            body {
                user-select: none;
                -webkit-user-select: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üì± Controle de Notas Fiscais</h1>
            <p>Scanner QR ‚Ä¢ Organiza√ß√£o ‚Ä¢ Relat√≥rios</p>
        </div>

        <!-- Status Bar -->
        <div class="status-bar" id="statusBar">
            üöÄ App carregado e pronto para uso!
        </div>

        <!-- Feature Cards -->
        <div class="feature-cards">
            <!-- Scanner QR REAL COM API -->
            <div class="feature-card camera-section">
                <h3>üì∑ Scanner QR + API Autom√°tica</h3>
                <p>L√™ QR Code e extrai dados reais via API da Secretaria da Fazenda</p>
                
                <button class="btn" onclick="iniciarScannerReal()" id="scanner-btn">
                    üîç Iniciar Scanner Autom√°tico
                </button>
                
                <button class="btn" onclick="pararScanner()" id="stop-btn" style="background: rgba(255,255,255,0.3); display: none;">
                    ‚èπÔ∏è Parar Scanner
                </button>
                
                <!-- Status da API -->
                <div id="api-status" style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px; font-size: 12px;">
                    üîß Status API: ${API_CONFIG.consumer_key === 'SEU_CONSUMER_KEY_AQUI' ? 'N√£o configurada' : 'Configurada'}
                </div>
                
                <!-- Container do Scanner -->
                <div id="qr-reader" style="width: 100%; margin-top: 15px; display: none;"></div>
                
                <!-- Resultado -->
                <div id="qr-result" style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.2); border-radius: 10px; display: none;">
                    <strong>QR Code Detectado:</strong>
                    <div id="qr-result-text"></div>
                </div>
            </div>

            <!-- Adi√ß√£o R√°pida -->
            <div class="feature-card quick-add-section">
                <h3>‚ö° Adi√ß√£o R√°pida</h3>
                <p>Bot√µes inteligentes para adicionar tipos comuns de gastos rapidamente</p>
                <div class="quick-buttons">
                    <button class="quick-btn" onclick="adicionarRapido('Supermercado', 'Alimenta√ß√£o')">
                        üõí Market
                    </button>
                    <button class="quick-btn" onclick="adicionarRapido('Posto', 'Transporte')">
                        ‚õΩ Posto
                    </button>
                    <button class="quick-btn" onclick="adicionarRapido('Farm√°cia', 'Sa√∫de')">
                        üíä Farm√°cia
                    </button>
                    <button class="quick-btn" onclick="adicionarRapido('Restaurante', 'Alimenta√ß√£o')">
                        üçΩÔ∏è Restaurante
                    </button>
                </div>
            </div>

            <!-- Estat√≠sticas -->
            <div class="feature-card stats-section">
                <h3>üìä Relat√≥rios</h3>
                <p>Acompanhe seus gastos mensais, categorias mais usadas e m√©dias</p>
                <button class="btn" onclick="mostrarEstatisticas()">
                    üìà Ver Estat√≠sticas
                </button>
            </div>
        </div>

        <!-- Formul√°rio -->
        <div class="form-section">
            <h3>üìù Detalhes da Nota Fiscal</h3>
            <form id="notaForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>üè™ Estabelecimento</label>
                        <input type="text" id="estabelecimento" placeholder="Ex: Supermercado Extra" required>
                    </div>
                    
                    <div class="form-group">
                        <label>üí∞ Valor (R$)</label>
                        <input type="number" id="valor" step="0.01" placeholder="0,00" required>
                    </div>
                    
                    <div class="form-group">
                        <label>üìÇ Categoria</label>
                        <select id="categoria" required>
                            <option value="">Selecione a categoria</option>
                            <option value="Alimenta√ß√£o">üçΩÔ∏è Alimenta√ß√£o</option>
                            <option value="Transporte">üöó Transporte</option>
                            <option value="Sa√∫de">üè• Sa√∫de</option>
                            <option value="Educa√ß√£o">üìö Educa√ß√£o</option>
                            <option value="Vestu√°rio">üëï Vestu√°rio</option>
                            <option value="Casa">üè† Casa</option>
                            <option value="Lazer">üéÆ Lazer</option>
                            <option value="Igreja">‚õ™ Igreja</option>
                            <option value="D√≠zimo">üôè D√≠zimo/Ofertas</option>
                            <option value="Trabalho">üíº Trabalho</option>
                            <option value="Outros">üì¶ Outros</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>üìÖ Data</label>
                        <input type="date" id="data" required>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    ‚úÖ Salvar Nota Fiscal
                </button>
            </form>
        </div>

        <!-- Resumo Financeiro -->
        <div class="summary">
            <div class="summary-card">
                <h3>Total M√™s</h3>
                <div class="value" id="totalMes">R$ 0</div>
            </div>
            <div class="summary-card">
                <h3>Total Notas</h3>
                <div class="value" id="totalNotas">0</div>
            </div>
            <div class="summary-card">
                <h3>M√©dia por Nota</h3>
                <div class="value" id="mediaNota">R$ 0</div>
            </div>
            <div class="summary-card">
                <h3>Categoria Top</h3>
                <div class="value" id="categoriaTop">-</div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filters">
            <div class="filter-group">
                <label>üîç Filtrar por Categoria:</label>
                <select id="filtroCategoria" onchange="filtrarNotas()">
                    <option value="">Todas as categorias</option>
                    <option value="Alimenta√ß√£o">üçΩÔ∏è Alimenta√ß√£o</option>
                    <option value="Transporte">üöó Transporte</option>
                    <option value="Sa√∫de">üè• Sa√∫de</option>
                    <option value="Educa√ß√£o">üìö Educa√ß√£o</option>
                    <option value="Vestu√°rio">üëï Vestu√°rio</option>
                    <option value="Casa">üè† Casa</option>
                    <option value="Lazer">üéÆ Lazer</option>
                    <option value="Igreja">‚õ™ Igreja</option>
                    <option value="D√≠zimo">üôè D√≠zimo/Ofertas</option>
                    <option value="Trabalho">üíº Trabalho</option>
                    <option value="Outros">üì¶ Outros</option>
                </select>
            </div>
            <div class="filter-group">
                <label>üìÜ Per√≠odo:</label>
                <input type="month" id="filtroMes" onchange="filtrarNotas()">
            </div>
        </div>

        <!-- Lista de Notas -->
        <div class="notes-list">
            <h3>üìã Suas Notas Fiscais</h3>
            <div id="listaNotas">
                <div class="empty-state">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üìÑ</div>
                    <h4>Nenhuma nota cadastrada ainda</h4>
                    <p>Use o scanner de QR Code, os bot√µes de adi√ß√£o r√°pida ou preencha o formul√°rio manualmente para come√ßar!</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado da aplica√ß√£o
        let notas = JSON.parse(localStorage.getItem('notas-fiscais-app') || '[]');
        let isProcessing = false;

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Configurar data atual
            document.getElementById('data').valueAsDate = new Date();
            document.getElementById('filtroMes').value = new Date().toISOString().substr(0, 7);
            
            // Verificar status da API
            updateAPIStatus();
            
            // Carregar dados existentes
            exibirNotas();
            atualizarResumo();
            
            // Configurar eventos
            document.getElementById('notaForm').addEventListener('submit', adicionarNota);
            
            // Anima√ß√£o de entrada suave
            document.querySelector('.container').classList.add('fade-in');
            
            updateStatus('üéâ App carregado com sucesso! Pronto para usar.');
        }

        function updateAPIStatus() {
            const statusElement = document.getElementById('api-status');
            const isConfigured = API_CONFIG.consumer_key !== 'SEU_CONSUMER_KEY_AQUI';
            
            if (isConfigured) {
                statusElement.innerHTML = '‚úÖ API Configurada - Extra√ß√£o autom√°tica ativa';
                statusElement.style.background = 'rgba(76, 175, 80, 0.3)';
            } else {
                statusElement.innerHTML = '‚öôÔ∏è API n√£o configurada - Consulta manual dispon√≠vel';
                statusElement.style.background = 'rgba(255, 152, 0, 0.3)';
            }
        }

        // Scanner QR REAL - Funciona no iPhone Safari
        let html5QrcodeScanner = null;
        let isRealScanning = false;

        function iniciarScannerReal() {
            updateStatus('üöÄ Inicializando scanner profissional...', true);
            
            // Mostrar container do scanner
            document.getElementById('qr-reader').style.display = 'block';
            document.getElementById('scanner-btn').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'inline-block';
            
            // Configura√ß√£o do scanner
            const config = {
                fps: 10, // Frames por segundo
                qrbox: { width: 250, height: 250 }, // √Årea de detec√ß√£o
                aspectRatio: 1.0, // Propor√ß√£o quadrada
                disableFlip: false, // Permitir c√≥digos espelhados
                supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
            };
            
            // Criar scanner
            html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", config, false);
            
            // Iniciar scanning
            html5QrcodeScanner.render(
                // Sucesso - QR Code detectado
                (decodedText, decodedResult) => {
                    updateStatus('‚úÖ QR Code lido com sucesso!');
                    vibrar([200, 100, 200]);
                    
                    // Mostrar resultado
                    document.getElementById('qr-result').style.display = 'block';
                    document.getElementById('qr-result-text').textContent = decodedText;
                    
                    // Processar dados
                    const dados = processarQRReal(decodedText);
                    preencherFormulario(dados);
                    
                    // Parar scanner automaticamente
                    setTimeout(() => {
                        pararScanner();
                        updateStatus(`üéâ Dados extra√≠dos: ${dados.estabelecimento}`);
                        
                        // Scroll para formul√°rio
                        document.querySelector('.form-section').scrollIntoView({ 
                            behavior: 'smooth' 
                        });
                    }, 2000);
                },
                
                // Erro
                (error) => {
                    // N√£o mostrar erros constantes de tentativa
                    console.log('Tentando detectar QR Code:', error);
                }
            );
            
            isRealScanning = true;
            updateStatus('üì∏ Scanner ativo! Posicione o QR Code da nota fiscal na √°rea marcada');
        }

        function pararScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear().then(() => {
                    // Scanner parado com sucesso
                    document.getElementById('qr-reader').style.display = 'none';
                    document.getElementById('scanner-btn').style.display = 'inline-block';
                    document.getElementById('stop-btn').style.display = 'none';
                    document.getElementById('qr-result').style.display = 'none';
                    
                    html5QrcodeScanner = null;
                    isRealScanning = false;
                    
                    updateStatus('üì± Scanner parado');
                }).catch(err => {
                    console.error('Erro ao parar scanner:', err);
                    updateStatus('‚ùå Erro ao parar scanner');
                });
            }
        }

        // Processar QR Code real - EXTRA√á√ÉO PARA CONSULTA SEFAZ
        function processarQRReal(qrData) {
            console.log('QR Code detectado:', qrData);
            
            let chaveAcesso = null;
            let urlConsulta = null;
            
            try {
                // EXTRAIR CHAVE DE ACESSO DA NF-e/NFC-e
                
                // M√©todo 1: URL com par√¢metros
                if (qrData.startsWith('http')) {
                    const url = new URL(qrData);
                    const params = new URLSearchParams(url.search);
                    
                    // Procurar chave nos par√¢metros da URL
                    for (let [key, value] of params) {
                        // Chave de NF-e tem 44 d√≠gitos
                        if (value.length === 44 && /^\d{44}$/.test(value)) {
                            chaveAcesso = value;
                            urlConsulta = qrData;
                            break;
                        }
                        // Alguns casos a chave vem como par√¢metro 'p'
                        if (key.toLowerCase() === 'p' || key.toLowerCase() === 'chave') {
                            chaveAcesso = value;
                            urlConsulta = qrData;
                            break;
                        }
                    }
                }
                
                // M√©todo 2: Dados separados por | (formato comum)
                if (!chaveAcesso && qrData.includes('|')) {
                    const partes = qrData.split('|');
                    for (let parte of partes) {
                        if (parte.length === 44 && /^\d{44}$/.test(parte)) {
                            chaveAcesso = parte;
                            break;
                        }
                    }
                }
                
                // M√©todo 3: Apenas a chave (44 d√≠gitos)
                if (!chaveAcesso && qrData.length === 44 && /^\d{44}$/.test(qrData)) {
                    chaveAcesso = qrData;
                }
                
                // M√©todo 4: Buscar qualquer sequ√™ncia de 44 d√≠gitos
                if (!chaveAcesso) {
                    const match = qrData.match(/\d{44}/);
                    if (match) {
                        chaveAcesso = match[0];
                    }
                }
                
                if (chaveAcesso) {
                    return consultarDadosNFe(chaveAcesso, urlConsulta, qrData);
                } else {
                    return processarQRSemChave(qrData);
                }
                
            } catch (error) {
                console.error('Erro ao processar QR:', error);
                return processarQRSemChave(qrData);
            }
        }

        // CONFIGURA√á√ÉO DA API - SUBSTITUA PELAS SUAS CREDENCIAIS
        const API_CONFIG = {
            // Para testar, voc√™ precisa se cadastrar em: https://webmaniabr.com
            consumer_key: 'SEU_CONSUMER_KEY_AQUI',
            consumer_secret: 'SEU_CONSUMER_SECRET_AQUI',
            access_token: 'SEU_ACCESS_TOKEN_AQUI',
            access_token_secret: 'SEU_ACCESS_TOKEN_SECRET_AQUI',
            url_base: 'https://webmaniabr.com/api/1/nfe/consulta/'
        };

        // Consultar dados reais da NF-e via API
        async function consultarDadosNFe(chaveAcesso, urlConsulta, qrOriginal) {
            console.log('Consultando chave de acesso:', chaveAcesso);
            
            updateStatus('üîç Consultando dados reais via API...', true);
            
            try {
                // Verificar se API est√° configurada
                if (API_CONFIG.consumer_key === 'SEU_CONSUMER_KEY_AQUI') {
                    return mostrarInstrucaoAPI(chaveAcesso, urlConsulta);
                }
                
                // Fazer consulta real na API
                const dadosReais = await consultarAPIWebmania(chaveAcesso);
                
                if (dadosReais.success) {
                    updateStatus('‚úÖ Dados reais obtidos via API!');
                    return dadosReais;
                } else {
                    throw new Error(dadosReais.error || 'Erro na consulta API');
                }
                
            } catch (error) {
                console.error('Erro na consulta API:', error);
                updateStatus('‚ùå Erro na API, usando consulta manual...');
                return consultarComInformacaoBasica(chaveAcesso, urlConsulta);
            }
        }

        // Consulta real via API Webmania
        async function consultarAPIWebmania(chaveAcesso) {
            try {
                const response = await fetch(API_CONFIG.url_base, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Consumer-Key': API_CONFIG.consumer_key,
                        'X-Consumer-Secret': API_CONFIG.consumer_secret,
                        'X-Access-Token': API_CONFIG.access_token,
                        'X-Access-Token-Secret': API_CONFIG.access_token_secret
                    },
                    body: JSON.stringify({
                        chave: chaveAcesso
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                // Processar resposta da API
                return processarRespostaAPI(data, chaveAcesso);
                
            } catch (error) {
                console.error('Erro na consulta Webmania:', error);
                
                // Se for erro de CORS, tentar via proxy
                if (error.message.includes('CORS') || error.message.includes('fetch')) {
                    return tentarViaProxy(chaveAcesso);
                }
                
                throw error;
            }
        }

        // Processar resposta da API
        function processarRespostaAPI(data, chaveAcesso) {
            console.log('Resposta da API:', data);
            
            let estabelecimento = 'Empresa via API';
            let categoria = 'Outros';
            let valor = '';
            
            try {
                // Extrair dados do emitente
                if (data.emitente) {
                    estabelecimento = data.emitente.razao_social || 
                                    data.emitente.nome_fantasia || 
                                    'Estabelecimento via API';
                }
                
                // Extrair valor total
                if (data.total) {
                    valor = parseFloat(data.total).toFixed(2);
                } else if (data.valor_total) {
                    valor = parseFloat(data.valor_total).toFixed(2);
                }
                
                // Categorizar baseado na atividade
                if (data.emitente && data.emitente.cnae) {
                    categoria = categorizarPorCNAE(data.emitente.cnae);
                } else if (estabelecimento) {
                    categoria = categorizarPorNome(estabelecimento);
                }
                
                // Mostrar sucesso com dados reais
                const sucesso = `
‚úÖ DADOS EXTRA√çDOS COM SUCESSO!

üè™ Estabelecimento: ${estabelecimento}
üí∞ Valor: R$ ${valor}
üìÇ Categoria: ${categoria}
üìÑ Tipo: ${data.modelo || 'NF-e'}
üìÖ Data: ${data.data_emissao || 'N/A'}

üéâ Informa√ß√µes reais obtidas da Secretaria da Fazenda!
                `;
                
                alert(sucesso);
                
                return {
                    success: true,
                    estabelecimento: estabelecimento,
                    categoria: categoria,
                    valor: valor,
                    chaveAcesso: chaveAcesso,
                    dadosCompletos: data
                };
                
            } catch (error) {
                console.error('Erro ao processar resposta:', error);
                throw new Error('Erro ao processar dados da API');
            }
        }

        // Tentar via proxy para contornar CORS
        async function tentarViaProxy(chaveAcesso) {
            try {
                updateStatus('üîÑ Tentando consulta via proxy...', true);
                
                // Usar servi√ßo de proxy p√∫blico (cors-anywhere ou similar)
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const targetUrl = API_CONFIG.url_base;
                
                const response = await fetch(proxyUrl + targetUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Consumer-Key': API_CONFIG.consumer_key,
                        'X-Consumer-Secret': API_CONFIG.consumer_secret,
                        'X-Access-Token': API_CONFIG.access_token,
                        'X-Access-Token-Secret': API_CONFIG.access_token_secret,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        chave: chaveAcesso
                    })
                });

                const data = await response.json();
                return processarRespostaAPI(data, chaveAcesso);
                
            } catch (error) {
                console.error('Erro no proxy:', error);
                throw new Error('Falha na consulta via proxy');
            }
        }

        // Categorizar empresa por CNAE
        function categorizarPorCNAE(cnae) {
            if (!cnae) return 'Outros';
            
            const categoriasCNAE = {
                '4711': 'Alimenta√ß√£o',  // Supermercados
                '4712': 'Alimenta√ß√£o',  // Minimercados
                '4713': 'Alimenta√ß√£o',  // Lojas de departamento
                '4721': 'Alimenta√ß√£o',  // Bebidas
                '4771': 'Sa√∫de',        // Farm√°cias
                '4772': 'Sa√∫de',        // Produtos farmac√™uticos
                '4731': 'Transporte',   // Combust√≠veis
                '4732': 'Transporte',   // Lubrificantes
                '4751': 'Casa',         // Eletrodom√©sticos
                '4752': 'Casa',         // Materiais constru√ß√£o
                '4753': 'Casa',         // Equipamentos
                '4754': 'Casa',         // M√≥veis
                '4755': 'Casa',         // Tecidos
                '4761': 'Educa√ß√£o',     // Livros
                '4762': 'Educa√ß√£o',     // Papelaria
                '4781': 'Alimenta√ß√£o',  // Alimenta√ß√£o geral
                '4782': 'Vestu√°rio',    // Vestu√°rio
                '4783': 'Vestu√°rio',    // Cal√ßados
                '4784': 'Sa√∫de',        // Artigos m√©dicos
                '4785': 'Sa√∫de',        // Produtos de higiene
                '4789': 'Outros',       // Outros produtos
                '5611': 'Alimenta√ß√£o',  // Restaurantes
                '5620': 'Alimenta√ß√£o'   // Servi√ßos de alimenta√ß√£o
            };
            
            const codigo = cnae.substring(0, 4);
            return categoriasCNAE[codigo] || 'Outros';
        }

        // Categorizar por nome do estabelecimento
        function categorizarPorNome(nome) {
            const nomeMinusculo = nome.toLowerCase();
            
            if (nomeMinusculo.includes('super') || nomeMinusculo.includes('mercado') || 
                nomeMinusculo.includes('atacad√£o') || nomeMinusculo.includes('extra') ||
                nomeMinusculo.includes('carrefour') || nomeMinusculo.includes('p√£o de a√ß√∫car')) {
                return 'Alimenta√ß√£o';
            }
            
            if (nomeMinusculo.includes('farm√°cia') || nomeMinusculo.includes('drogaria') ||
                nomeMinusculo.includes('droga') || nomeMinusculo.includes('drogasil')) {
                return 'Sa√∫de';
            }
            
            if (nomeMinusculo.includes('posto') || nomeMinusculo.includes('combust√≠vel') ||
                nomeMinusculo.includes('shell') || nomeMinusculo.includes('petrobras') ||
                nomeMinusculo.includes('ipiranga')) {
                return 'Transporte';
            }
            
            if (nomeMinusculo.includes('casas bahia') || nomeMinusculo.includes('magazine') ||
                nomeMinusculo.includes('americanas') || nomeMinusculo.includes('fast shop')) {
                return 'Casa';
            }
            
            if (nomeMinusculo.includes('renner') || nomeMinusculo.includes('c&a') ||
                nomeMinusculo.includes('zara') || nomeMinusculo.includes('riachuelo')) {
                return 'Vestu√°rio';
            }
            
            if (nomeMinusculo.includes('mc donald') || nomeMinusculo.includes('burger') ||
                nomeMinusculo.includes('pizza') || nomeMinusculo.includes('restaurante')) {
                return 'Alimenta√ß√£o';
            }
            
            return 'Outros';
        }

        // Mostrar instru√ß√µes para configurar API
        function mostrarInstrucaoAPI(chaveAcesso, urlConsulta) {
            const instrucoes = `
üîë API N√ÉO CONFIGURADA

Para extrair dados automaticamente, voc√™ precisa:

1Ô∏è‚É£ CADASTRAR-SE:
‚Ä¢ Acesse: webmaniabr.com
‚Ä¢ Crie conta gratuita
‚Ä¢ Ative plano de consulta NF-e

2Ô∏è‚É£ OBTER CREDENCIAIS:
‚Ä¢ Consumer Key
‚Ä¢ Consumer Secret  
‚Ä¢ Access Token
‚Ä¢ Access Token Secret

3Ô∏è‚É£ CONFIGURAR NO C√ìDIGO:
‚Ä¢ Substitua as credenciais no arquivo
‚Ä¢ Linhas 250-255 aproximadamente

üí∞ CUSTO:
‚Ä¢ Plano b√°sico: ~R$ 29/m√™s
‚Ä¢ Por consulta: ~R$ 0,10

üÜì ALTERNATIVA GRATUITA:
‚Ä¢ Consulta manual no site oficial

üîß DADOS EXTRA√çDOS DA CHAVE:
${chaveAcesso}

Deseja abrir consulta manual agora?
            `;
            
            const abrirManual = confirm(instrucoes);
            
            if (abrirManual && urlConsulta) {
                window.open(urlConsulta, '_blank');
                updateStatus('üåê Consulta manual aberta. Copie os dados reais!');
            } else {
                updateStatus('üìù Configure a API para extra√ß√£o autom√°tica');
            }
            
            return consultarComInformacaoBasica(chaveAcesso, urlConsulta);
        }

        // Consulta com informa√ß√µes b√°sicas + assistente
        function consultarComInformacaoBasica(chaveAcesso, urlConsulta) {
            // Decodificar informa√ß√µes da chave
            const uf = chaveAcesso.substring(0, 2);
            const aamm = chaveAcesso.substring(2, 6);
            const cnpj = chaveAcesso.substring(6, 20);
            const modelo = chaveAcesso.substring(20, 22);
            const numero = chaveAcesso.substring(25, 34);
            
            const ufs = {
                '11': 'RO', '12': 'AC', '13': 'AM', '14': 'RR', '15': 'PA', 
                '16': 'AP', '17': 'TO', '21': 'MA', '22': 'PI', '23': 'CE', 
                '24': 'RN', '25': 'PB', '26': 'PE', '27': 'AL', '28': 'SE', 
                '29': 'BA', '31': 'MG', '32': 'ES', '33': 'RJ', '35': 'SP',
                '41': 'PR', '42': 'SC', '43': 'RS', '50': 'MS', '51': 'MT', 
                '52': 'GO', '53': 'DF'
            };
            
            const estado = ufs[uf] || 'BR';
            const tipoNF = modelo === '55' ? 'NF-e' : modelo === '65' ? 'NFC-e' : 'NF';
            
            // Mostrar assistente para consulta manual
            const assistente = `
ü§ñ ASSISTENTE DE CONSULTA NF-e

‚úÖ CHAVE EXTRA√çDA: ${chaveAcesso}
üìÑ Tipo: ${tipoNF}
üó∫Ô∏è Estado: ${estado}  
üìã N√∫mero: ${numero}

üéØ COMO OBTER DADOS REAIS:

1Ô∏è‚É£ AUTOM√ÅTICO (recomendado):
‚Ä¢ Use APIs pagas: NFE.io, Webmania, Infosimples
‚Ä¢ Custo: R$ 0,05 a R$ 0,20 por consulta
‚Ä¢ Retorna: valor, produtos, estabelecimento real

2Ô∏è‚É£ MANUAL (gratuito):
‚Ä¢ Abra a consulta oficial do SEFAZ
‚Ä¢ Copie os dados reais da nota
‚Ä¢ Volte e preencha manualmente

üí° PARA IMPLEMENTAR API:
‚Ä¢ Contrate servi√ßo de consulta NF-e
‚Ä¢ Adicione credenciais no c√≥digo
‚Ä¢ Consulta autom√°tica funcionar√°

üåê CONSULTAR AGORA?
            `;
            
            const consultarOficial = confirm(assistente + '\n\nDeseja abrir a consulta oficial do SEFAZ?');
            
            if (consultarOficial && urlConsulta) {
                window.open(urlConsulta, '_blank');
                updateStatus('üåê Consulta oficial aberta em nova aba. Copie os dados reais!');
            } else {
                updateStatus('üìù Preencha os dados manualmente ap√≥s consultar no SEFAZ');
            }
            
            return {
                estabelecimento: `${tipoNF} ${estado} #${numero}`,
                categoria: 'Outros',
                valor: '', // Deixar vazio para preenchimento manual
                chaveAcesso: chaveAcesso,
                consultaManual: true
            };
        }

        // Processar QR codes sem chave de NF-e
        function processarQRSemChave(qrData) {
            let estabelecimento = 'QR Code Lido';
            let categoria = 'Outros';
            let valor = '';
            
            // Mostrar conte√∫do do QR Code para an√°lise manual
            const conteudo = `
üì± CONTE√öDO DO QR CODE:

${qrData}

üí° COMO PROCEDER:
1. Este QR Code n√£o cont√©m uma chave de NF-e padr√£o
2. Verifique se √© realmente de uma nota fiscal
3. Se for, use o app C√¢mera do iPhone para abrir o link
4. Ou preencha os dados manualmente abaixo

‚ùì POSS√çVEIS TIPOS:
‚Ä¢ Link de site/loja
‚Ä¢ C√≥digo de produto
‚Ä¢ Informa√ß√µes de contato
‚Ä¢ Outro tipo de dados
            `;
            
            alert(conteudo);
            
            // Tentar categorizar baseado no conte√∫do
            const texto = qrData.toLowerCase();
            
            if (texto.includes('super') || texto.includes('mercado')) {
                estabelecimento = 'Supermercado (via QR)';
                categoria = 'Alimenta√ß√£o';
            } else if (texto.includes('farmacia') || texto.includes('drogaria')) {
                estabelecimento = 'Farm√°cia (via QR)';
                categoria = 'Sa√∫de';
            } else if (texto.includes('posto') || texto.includes('combustivel')) {
                estabelecimento = 'Posto (via QR)';
                categoria = 'Transporte';
            } else if (qrData.startsWith('http')) {
                try {
                    const domain = new URL(qrData).hostname;
                    estabelecimento = `Site: ${domain.replace('www.', '')}`;
                } catch (e) {
                    estabelecimento = 'Link via QR Code';
                }
            } else {
                estabelecimento = qrData.length > 30 ? 
                    qrData.substring(0, 30) + '...' : 
                    qrData;
            }
            
            return {
                estabelecimento,
                categoria,
                valor: '', // Deixar vazio para preenchimento manual
                qrContent: qrData
            };
        }

        function simularLeituraQR() {
            const estabelecimentos = [
                { nome: 'Supermercado P√£o de A√ß√∫car', categoria: 'Alimenta√ß√£o', faixa: [20, 150] },
                { nome: 'Farm√°cia Droga Raia', categoria: 'Sa√∫de', faixa: [15, 80] },
                { nome: 'Posto Shell', categoria: 'Transporte', faixa: [50, 200] },
                { nome: 'McDonald\'s', categoria: 'Alimenta√ß√£o', faixa: [25, 60] },
                { nome: 'Casas Bahia', categoria: 'Casa', faixa: [100, 500] },
                { nome: 'Renner', categoria: 'Vestu√°rio', faixa: [80, 300] },
                { nome: 'Atacad√£o', categoria: 'Alimenta√ß√£o', faixa: [40, 200] },
                { nome: 'Drogasil', categoria: 'Sa√∫de', faixa: [10, 120] },
                { nome: 'Subway', categoria: 'Alimenta√ß√£o', faixa: [20, 45] },
                { nome: 'Leroy Merlin', categoria: 'Casa', faixa: [30, 400] }
            ];
            
            const estabelecimento = estabelecimentos[Math.floor(Math.random() * estabelecimentos.length)];
            const valor = (Math.random() * (estabelecimento.faixa[1] - estabelecimento.faixa[0]) + estabelecimento.faixa[0]).toFixed(2);
            
            return {
                estabelecimento: estabelecimento.nome,
                categoria: estabelecimento.categoria,
                valor: valor
            };
        }

        function preencherFormulario(dados) {
            if (dados.estabelecimento) {
                document.getElementById('estabelecimento').value = dados.estabelecimento;
            }
            if (dados.categoria) {
                document.getElementById('categoria').value = dados.categoria;
            }
            if (dados.valor) {
                document.getElementById('valor').value = dados.valor;
            }
            
            // Se extraiu chave de acesso, mostrar informa√ß√µes extras
            if (dados.chaveAcesso) {
                updateStatus(`üîë Chave extra√≠da! Use para consulta oficial no SEFAZ`);
                
                // Adicionar bot√£o para consulta r√°pida
                const formSection = document.querySelector('.form-section');
                let consultaDiv = document.getElementById('consulta-info');
                
                if (!consultaDiv) {
                    consultaDiv = document.createElement('div');
                    consultaDiv.id = 'consulta-info';
                    consultaDiv.style.cssText = `
                        background: linear-gradient(135deg, #2196F3, #1976D2);
                        color: white;
                        padding: 20px;
                        border-radius: 12px;
                        margin-bottom: 20px;
                        text-align: center;
                    `;
                    formSection.appendChild(consultaDiv);
                }
                
                consultaDiv.innerHTML = `
                    <h4>üîç Consulta Oficial Dispon√≠vel</h4>
                    <p>Chave extra√≠da: ${dados.chaveAcesso}</p>
                    ${dados.urlConsulta ? `
                        <button type="button" onclick="window.open('${dados.urlConsulta}', '_blank')" 
                                style="background: white; color: #2196F3; border: none; padding: 10px 20px; border-radius: 8px; margin-top: 10px; cursor: pointer;">
                            üåê Consultar no SEFAZ
                        </button>
                    ` : ''}
                    <p style="font-size: 12px; margin-top: 10px; opacity: 0.9;">
                        üí° Complete o valor real ap√≥s consultar oficialmente
                    </p>
                `;
            }
            
            // Anima√ß√£o nos campos preenchidos
            ['estabelecimento', 'categoria', 'valor'].forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento.value) {
                    elemento.style.background = '#e8f5e8';
                    elemento.style.transform = 'scale(1.02)';
                    setTimeout(() => {
                        elemento.style.background = '';
                        elemento.style.transform = '';
                    }, 1000);
                }
            });
        }

        function adicionarRapido(tipo, categoria) {
            document.getElementById('estabelecimento').value = `${tipo} (Adi√ß√£o R√°pida)`;
            document.getElementById('categoria').value = categoria;
            
            // Focar no campo valor
            document.getElementById('valor').focus();
            document.getElementById('valor').select();
            
            updateStatus(`‚ö° ${tipo} selecionado! Complete o valor e salve.`);
            
            // Scroll para o formul√°rio
            document.querySelector('.form-section').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }

        function adicionarNota(event) {
            event.preventDefault();
            
            if (isProcessing) return;
            isProcessing = true;
            
            updateStatus('üíæ Salvando nota fiscal...', true);
            
            const nota = {
                id: Date.now(),
                estabelecimento: document.getElementById('estabelecimento').value.trim(),
                valor: parseFloat(document.getElementById('valor').value),
                categoria: document.getElementById('categoria').value,
                data: document.getElementById('data').value,
                timestamp: new Date().toISOString(),
                mes: document.getElementById('data').value.substr(0, 7)
            };
            
            // Simular delay de salvamento
            setTimeout(() => {
                notas.push(nota);
                localStorage.setItem('notas-fiscais-app', JSON.stringify(notas));
                
                exibirNotas();
                atualizarResumo();
                
                // Limpar formul√°rio
                document.getElementById('notaForm').reset();
                document.getElementById('data').valueAsDate = new Date();
                
                updateStatus(`‚úÖ Nota fiscal de ${nota.estabelecimento} salva com sucesso!`);
                
                // Scroll para o topo
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                isProcessing = false;
            }, 1000);
        }

        function exibirNotas() {
            const container = document.getElementById('listaNotas');
            const notasFiltradas = obterNotasFiltradas();
            
            if (notasFiltradas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 4rem; margin-bottom: 20px;">üìÑ</div>
                        <h4>Nenhuma nota encontrada</h4>
                        <p>Ajuste os filtros ou adicione novas notas fiscais</p>
                    </div>
                `;
                return;
            }
            
            const html = notasFiltradas.map(nota => `
                <div class="note-item fade-in">
                    <div class="note-header">
                        <div class="note-info">
                            <h4>${obterIconeCategoria(nota.categoria)} ${nota.estabelecimento}</h4>
                            <div class="note-details">
                                <div>üìÖ ${formatarData(nota.data)}</div>
                                <div>üìÇ ${nota.categoria}</div>
                                <div>‚è∞ ${formatarHora(nota.timestamp)}</div>
                            </div>
                            <div class="note-value">R$ ${nota.valor.toFixed(2).replace('.', ',')}</div>
                        </div>
                        <button class="btn btn-danger btn-small" onclick="excluirNota(${nota.id})" title="Excluir nota">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function obterNotasFiltradas() {
            const filtroCategoria = document.getElementById('filtroCategoria').value;
            const filtroMes = document.getElementById('filtroMes').value;
            
            return notas.filter(nota => {
                const categoriaValida = !filtroCategoria || nota.categoria === filtroCategoria;
                const mesValido = !filtroMes || nota.data.startsWith(filtroMes);
                return categoriaValida && mesValido;
            }).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        function filtrarNotas() {
            exibirNotas();
            atualizarResumo();
            updateStatus('üîç Filtros aplicados!');
        }

        function atualizarResumo() {
            const mesAtual = document.getElementById('filtroMes').value || new Date().toISOString().substr(0, 7);
            const notasDoMes = notas.filter(nota => nota.data.startsWith(mesAtual));
            const notasFiltradas = obterNotasFiltradas();
            
            // C√°lculos
            const totalMes = notasDoMes.reduce((total, nota) => total + nota.valor, 0);
            const totalNotasExibidas = notasFiltradas.length;
            const media = notasDoMes.length > 0 ? totalMes / notasDoMes.length : 0;
            
            // Categoria mais usada
            const categorias = {};
            notasDoMes.forEach(nota => {
                categorias[nota.categoria] = (categorias[nota.categoria] || 0) + nota.valor;
            });
            
            const categoriaTop = Object.keys(categorias).length > 0 ? 
                Object.keys(categorias).reduce((a, b) => categorias[a] > categorias[b] ? a : b) : '-';
            
            // Atualizar interface com anima√ß√£o
            animarValor('totalMes', `R$ ${Math.round(totalMes)}`);
            animarValor('totalNotas', totalNotasExibidas);
            animarValor('mediaNota', `R$ ${Math.round(media)}`);
            animarValor('categoriaTop', obterIconeCategoria(categoriaTop) + ' ' + (categoriaTop === '-' ? '-' : categoriaTop.split(' ')[0]));
        }

        function animarValor(elementId, novoValor) {
            const elemento = document.getElementById(elementId);
            elemento.style.transform = 'scale(1.1)';
            elemento.style.color = '#4CAF50';
            
            setTimeout(() => {
                elemento.textContent = novoValor;
                elemento.style.transform = 'scale(1)';
                elemento.style.color = '';
            }, 200);
        }

        function excluirNota(id) {
            const nota = notas.find(n => n.id === id);
            if (!nota) return;
            
            if (confirm(`üóëÔ∏è Tem certeza que deseja excluir a nota:\n\n${nota.estabelecimento}\nR$ ${nota.valor.toFixed(2).replace('.', ',')}\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
                notas = notas.filter(nota => nota.id !== id);
                localStorage.setItem('notas-fiscais-app', JSON.stringify(notas));
                exibirNotas();
                atualizarResumo();
                updateStatus('üóëÔ∏è Nota fiscal exclu√≠da com sucesso!');
            }
        }

        function mostrarEstatisticas() {
            if (notas.length === 0) {
                alert('üìä Ainda n√£o h√° dados suficientes para estat√≠sticas!\n\nAdicione algumas notas fiscais primeiro.');
                return;
            }
            
            // Calcular estat√≠sticas avan√ßadas
            const mesAtual = new Date().toISOString().substr(0, 7);
            const notasMesAtual = notas.filter(nota => nota.data.startsWith(mesAtual));
            const notasMesAnterior = notas.filter(nota => {
                const mesAnterior = new Date();
                mesAnterior.setMonth(mesAnterior.getMonth() - 1);
                return nota.data.startsWith(mesAnterior.toISOString().substr(0, 7));
            });
            
            const totalAtual = notasMesAtual.reduce((sum, nota) => sum + nota.valor, 0);
            const totalAnterior = notasMesAnterior.reduce((sum, nota) => sum + nota.valor, 0);
            const variacao = totalAnterior > 0 ? ((totalAtual - totalAnterior) / totalAnterior * 100).toFixed(1) : 0;
            
            // Categorias por valor
            const categoriasPorValor = {};
            notas.forEach(nota => {
                categoriasPorValor[nota.categoria] = (categoriasPorValor[nota.categoria] || 0) + nota.valor;
            });
            
            const categoriasOrdenadas = Object.entries(categoriasPorValor)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            const estatisticas = `
üìä RELAT√ìRIO FINANCEIRO DETALHADO

üí∞ RESUMO MENSAL:
‚Ä¢ Este m√™s: R$ ${totalAtual.toFixed(2).replace('.', ',')}
‚Ä¢ M√™s anterior: R$ ${totalAnterior.toFixed(2).replace('.', ',')}
‚Ä¢ Varia√ß√£o: ${variacao > 0 ? '‚ÜóÔ∏è' : variacao < 0 ? '‚ÜòÔ∏è' : '‚û°Ô∏è'} ${Math.abs(variacao)}%

üìà ESTAT√çSTICAS GERAIS:
‚Ä¢ Total de notas: ${notas.length}
‚Ä¢ Valor total registrado: R$ ${notas.reduce((sum, nota) => sum + nota.valor, 0).toFixed(2).replace('.', ',')}
‚Ä¢ Gasto m√©dio por nota: R$ ${(notas.reduce((sum, nota) => sum + nota.valor, 0) / notas.length).toFixed(2).replace('.', ',')}

üèÜ TOP 5 CATEGORIAS:
${categoriasOrdenadas.map(([cat, valor], index) => 
    `${index + 1}. ${obterIconeCategoria(cat)} ${cat}: R$ ${valor.toFixed(2).replace('.', ',')}`
).join('\n')}

üìÖ PER√çODO: ${Math.ceil((new Date() - new Date(notas[notas.length - 1]?.data || new Date())) / (1000 * 60 * 60 * 24))} dias de controle
            `;
            
            alert(estatisticas);
        }

        function updateStatus(mensagem, loading = false) {
            const statusBar = document.getElementById('statusBar');
            statusBar.innerHTML = loading ? 
                `<span class="processing-indicator"></span> ${mensagem}` : 
                mensagem;
            
            // Auto-clear status ap√≥s 3 segundos (exceto se loading)
            if (!loading) {
                setTimeout(() => {
                    statusBar.textContent = 'üöÄ App pronto para uso!';
                }, 3000);
            }
        }

        // Fun√ß√µes utilit√°rias
        function formatarData(data) {
            return new Date(data + 'T00:00:00').toLocaleDateString('pt-BR');
        }

        function formatarHora(timestamp) {
            return new Date(timestamp).toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function obterIconeCategoria(categoria) {
            const icones = {
                'Alimenta√ß√£o': 'üçΩÔ∏è',
                'Transporte': 'üöó',
                'Sa√∫de': 'üè•',
                'Educa√ß√£o': 'üìö',
                'Vestu√°rio': 'üëï',
                'Casa': 'üè†',
                'Lazer': 'üéÆ',
                'Igreja': '‚õ™',
                'D√≠zimo': 'üôè',
                'Trabalho': 'üíº',
                'Outros': 'üì¶'
            };
            return icones[categoria] || 'üìÑ';
        }

        // Funcionalidades extras
        function exportarDados() {
            if (notas.length === 0) {
                alert('üìù Nenhuma nota para exportar!');
                return;
            }
            
            const dados = {
                exportDate: new Date().toISOString(),
                totalNotas: notas.length,
                notas: notas
            };
            
            const blob = new Blob([JSON.stringify(dados, null, 2)], { 
                type: 'application/json' 
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `notas-fiscais-backup-${new Date().toISOString().substr(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            updateStatus('üìÅ Backup dos dados exportado com sucesso!');
        }

        function importarDados(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const dados = JSON.parse(e.target.result);
                    if (dados.notas && Array.isArray(dados.notas)) {
                        if (confirm(`üì• Importar ${dados.notas.length} notas?\n\nIsso ir√° SUBSTITUIR todos os dados atuais!`)) {
                            notas = dados.notas;
                            localStorage.setItem('notas-fiscais-app', JSON.stringify(notas));
                            exibirNotas();
                            atualizarResumo();
                            updateStatus('üì• Dados importados com sucesso!');
                        }
                    } else {
                        alert('‚ùå Arquivo inv√°lido!');
                    }
                } catch (error) {
                    alert('‚ùå Erro ao ler arquivo: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Atalhos de teclado
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + S = Salvar nota
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                document.getElementById('notaForm').dispatchEvent(new Event('submit'));
            }
            
            // Ctrl/Cmd + E = Exportar
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                exportarDados();
            }
            
            // Esc = Limpar formul√°rio
            if (e.key === 'Escape') {
                document.getElementById('notaForm').reset();
                document.getElementById('data').valueAsDate = new Date();
                updateStatus('üßπ Formul√°rio limpo!');
            }
        });

        // Service Worker para PWA (funcionalidade b√°sica)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // Registrar service worker seria feito aqui em produ√ß√£o
                console.log('PWA: Service Worker suportado');
            });
        }

        // Detectar se foi adicionado √† tela inicial
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostrar banner de instala√ß√£o ap√≥s 10 segundos
            setTimeout(() => {
                if (confirm('üì± Deseja adicionar este app √† sua tela inicial?\n\nIsso permitir√° acesso mais r√°pido e uma experi√™ncia similar a um app nativo!')) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            updateStatus('üéâ App adicionado √† tela inicial!');
                        }
                        deferredPrompt = null;
                    });
                }
            }, 10000);
        });

        // Feedback h√°ptico (vibra√ß√£o) em dispositivos m√≥veis
        function vibrar(pattern = [100]) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        // Adicionar vibra√ß√£o aos bot√µes importantes
        document.addEventListener('click', function(e) {
            if (e.target.matches('.btn-primary, .camera-btn, .quick-btn')) {
                vibrar([50]);
            }
        });

        // Auto-save draft do formul√°rio
        ['estabelecimento', 'valor', 'categoria'].forEach(id => {
            document.getElementById(id).addEventListener('input', function() {
                const draft = {
                    estabelecimento: document.getElementById('estabelecimento').value,
                    valor: document.getElementById('valor').value,
                    categoria: document.getElementById('categoria').value
                };
                localStorage.setItem('draft-nota', JSON.stringify(draft));
            });
        });

        // Restaurar draft ao carregar
        const draft = JSON.parse(localStorage.getItem('draft-nota') || '{}');
        if (draft.estabelecimento || draft.valor || draft.categoria) {
            setTimeout(() => {
                if (confirm('üìù H√° um rascunho salvo. Deseja restaur√°-lo?')) {
                    Object.keys(draft).forEach(key => {
                        if (draft[key]) {
                            document.getElementById(key).value = draft[key];
                        }
                    });
                    updateStatus('üìù Rascunho restaurado!');
                }
            }, 2000);
        }

        // Limpar draft ao salvar
        document.getElementById('notaForm').addEventListener('submit', function() {
            localStorage.removeItem('draft-nota');
        });
    </script>
</body>
</html>
