<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de QR Code - Notas</title>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 10px; }
        .categoria { margin-top: 15px; }
        button { padding: 5px 10px; margin: 5px; }
    </style>
</head>
<body>

<h2>Leitor de QR Code - Notas</h2>
<div id="reader" style="width:100%;"></div>
<button onclick="startScan()">Escanear Nota</button>

<div id="notas"></div>
<button onclick="gerarPDF()">Gerar PDF</button>

<script>
let notas = JSON.parse(localStorage.getItem('notas')) || [];
atualizarNotas();

function startScan() {
    let html5QrcodeScanner = new Html5QrcodeScanner(
        "reader", { fps: 10, qrbox: 250 }, false);

    html5QrcodeScanner.render((qrCodeMessage) => {
        html5QrcodeScanner.clear();
        processarQRCode(qrCodeMessage);
    });
}

function processarQRCode(conteudo) {
    let categoria = prompt("Insira a categoria da nota:");
    let valor = parseFloat(prompt("Valor da nota:"));

    notas.push({ categoria: categoria, valor: valor, conteudo: conteudo });
    localStorage.setItem('notas', JSON.stringify(notas));

    atualizarNotas();
}

function atualizarNotas() {
    let container = document.getElementById('notas');
    container.innerHTML = '';

    let categorias = {};

    notas.forEach((nota, index) => {
        categorias[nota.categoria] = categorias[nota.categoria] || [];
        categorias[nota.categoria].push({ valor: nota.valor, index });
    });

    for (let categoria in categorias) {
        let total = categorias[categoria].reduce((sum, nota) => sum + nota.valor, 0);

        let div = document.createElement('div');
        div.className = 'categoria';
        div.innerHTML = `<strong>${categoria} - Total: R$ ${total.toFixed(2)}</strong>`;

        categorias[categoria].forEach(nota => {
            div.innerHTML += `<div>Nota: R$ ${nota.valor.toFixed(2)} 
            <button onclick="excluirNota(${nota.index})">Excluir</button></div>`;
        });

        container.appendChild(div);
    }
}

function excluirNota(index) {
    notas.splice(index, 1);
    localStorage.setItem('notas', JSON.stringify(notas));
    atualizarNotas();
}

async function gerarPDF() {
    const { jsPDF } = window.jspdf;
    let doc = new jsPDF();

    doc.text('RelatÃ³rio de Notas', 10, 10);
    let y = 20;

    notas.forEach((nota, i) => {
        doc.text(`${i+1}. Categoria: ${nota.categoria}, Valor: R$ ${nota.valor.toFixed(2)}`, 10, y);
        y += 10;
        if (y > 280) {
            doc.addPage();
            y = 10;
        }
    });

    doc.save('notas.pdf');
}
</script>

</body>
</html>
