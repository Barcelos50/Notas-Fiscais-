<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Leitor de Notas Fiscais</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f7;
            color: #1d1d1f;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, #007aff 0%, #0051d5 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .container {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .scan-button {
            background: #007aff;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            width: 100%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .scan-button:hover {
            background: #0051d5;
            transform: translateY(-2px);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }

        .stat-card h3 {
            color: #86868b;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            color: #1d1d1f;
            font-size: 24px;
            font-weight: 600;
        }

        .category-filter {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
            margin-bottom: 20px;
        }

        .category-chip {
            background: white;
            border: 1px solid #d2d2d7;
            padding: 8px 16px;
            border-radius: 20px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-chip.active {
            background: #007aff;
            color: white;
            border-color: #007aff;
        }

        .receipt-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .receipt-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: relative;
            transition: all 0.3s ease;
        }

        .receipt-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .receipt-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .receipt-title {
            font-size: 18px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .receipt-value {
            font-size: 20px;
            font-weight: 700;
            color: #007aff;
        }

        .receipt-info {
            display: flex;
            gap: 15px;
            color: #86868b;
            font-size: 14px;
        }

        .receipt-category {
            background: #f5f5f7;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            color: #1d1d1f;
            margin-top: 10px;
            display: inline-block;
        }

        .delete-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #ff3b30;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .receipt-card:hover .delete-button {
            opacity: 1;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #86868b;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #d2d2d7;
            border-radius: 10px;
            font-size: 16px;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #007aff;
            color: white;
        }

        .btn-secondary {
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .export-button {
            background: #34c759;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px auto;
            transition: all 0.3s ease;
        }

        .export-button:hover {
            background: #30a14e;
            transform: translateY(-2px);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #86868b;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            opacity: 0.5;
            margin-bottom: 20px;
        }

        #scanner-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: black;
            z-index: 2000;
            display: none;
        }

        #scanner-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            border: 2px solid white;
            border-radius: 20px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
        }

        .close-scanner {
            position: absolute;
            top: 40px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .month-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .month-selector button {
            background: #007aff;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .month-selector .current-month {
            font-size: 18px;
            font-weight: 600;
            min-width: 150px;
            text-align: center;
        }

        @media (max-width: 600px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üí∞ Minhas Notas Fiscais</h1>
    </div>

    <div class="container">
        <button class="scan-button" onclick="startScanner()">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
                <path d="M7 7h.01M7 17h.01M17 7h.01M17 17h.01M12 12h.01M7 12h10M12 7v10"/>
            </svg>
            Escanear QR Code
        </button>

        <div class="month-selector">
            <button onclick="changeMonth(-1)">‚Üê</button>
            <div class="current-month" id="currentMonth">Janeiro 2025</div>
            <button onclick="changeMonth(1)">‚Üí</button>
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <h3>Total do M√™s</h3>
                <div class="value" id="monthTotal">R$ 0,00</div>
            </div>
            <div class="stat-card">
                <h3>Quantidade</h3>
                <div class="value" id="receiptCount">0</div>
            </div>
        </div>

        <div class="category-filter" id="categoryFilter">
            <div class="category-chip active" onclick="filterByCategory('all')">Todas</div>
        </div>

        <div class="receipt-list" id="receiptList">
            <div class="empty-state">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <p>Nenhuma nota fiscal encontrada</p>
                <p>Toque no bot√£o acima para escanear</p>
            </div>
        </div>

        <button class="export-button" onclick="exportToPDF()">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2v9m0 0l-3-3m3 3l3-3M3 17v3a2 2 0 002 2h14a2 2 0 002-2v-3"/>
            </svg>
            Exportar para PDF
        </button>
    </div>

    <div id="scanner-container">
        <video id="video"></video>
        <div class="scanner-overlay"></div>
        <button class="close-scanner" onclick="stopScanner()">√ó</button>
    </div>

    <div class="modal" id="receiptModal">
        <div class="modal-content">
            <h2>Nova Nota Fiscal</h2>
            <form id="receiptForm">
                <div class="form-group">
                    <label>Estabelecimento</label>
                    <input type="text" id="establishment" required>
                </div>
                <div class="form-group">
                    <label>Data</label>
                    <input type="date" id="date" required>
                </div>
                <div class="form-group">
                    <label>Valor</label>
                    <input type="number" id="value" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="category" required>
                        <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
                        <option value="Transporte">Transporte</option>
                        <option value="Sa√∫de">Sa√∫de</option>
                        <option value="Educa√ß√£o">Educa√ß√£o</option>
                        <option value="Lazer">Lazer</option>
                        <option value="Compras">Compras</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Chave de Acesso</label>
                    <input type="text" id="accessKey">
                </div>
                <div class="form-buttons">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script>
        // Estado da aplica√ß√£o
        let receipts = JSON.parse(localStorage.getItem('receipts') || '[]');
        let currentMonth = new Date();
        let activeCategory = 'all';
        let codeReader = null;

        // Categorias dispon√≠veis
        const categories = ['Alimenta√ß√£o', 'Transporte', 'Sa√∫de', 'Educa√ß√£o', 'Lazer', 'Compras', 'Outros'];

        // Inicializar app
        function init() {
            updateMonthDisplay();
            updateCategoryFilter();
            renderReceipts();
            updateStats();
            
            // Inicializar leitor de QR Code
            codeReader = new ZXing.BrowserQRCodeReader();
        }

        // Scanner de QR Code
        async function startScanner() {
            try {
                const scannerContainer = document.getElementById('scanner-container');
                scannerContainer.style.display = 'block';
                
                // Listar c√¢meras dispon√≠veis
                const videoInputDevices = await codeReader.listVideoInputDevices();
                
                // Preferir c√¢mera traseira
                const selectedDevice = videoInputDevices.find(device => 
                    device.label.toLowerCase().includes('back') || 
                    device.label.toLowerCase().includes('traseira') ||
                    device.label.toLowerCase().includes('environment')
                ) || videoInputDevices[0];
                
                if (!selectedDevice) {
                    throw new Error('Nenhuma c√¢mera encontrada');
                }
                
                // Iniciar leitura
                codeReader.decodeFromVideoDevice(selectedDevice.deviceId, 'video', (result, err) => {
                    if (result) {
                        // QR Code lido com sucesso
                        console.log('QR Code detectado:', result.text);
                        processQRCode(result.text);
                        stopScanner();
                    }
                    
                    if (err && !(err instanceof ZXing.NotFoundException)) {
                        console.error('Erro na leitura:', err);
                    }
                });
                
            } catch (error) {
                console.error('Erro ao acessar c√¢mera:', error);
                alert('Erro ao acessar a c√¢mera. Verifique as permiss√µes.');
                stopScanner();
            }
        }

        function stopScanner() {
            if (codeReader) {
                codeReader.reset();
            }
            document.getElementById('scanner-container').style.display = 'none';
        }

        // Processar dados do QR Code
        function processQRCode(qrData) {
            try {
                // Padr√£o do QR Code de NFe
                // Exemplo: https://www.sefaz.rs.gov.br/NFCE/NFCE-COM.aspx?chNFe=12345...&nVersao=100&tpAmb=1...
                
                let extractedData = {
                    establishment: '',
                    date: new Date().toISOString().split('T')[0],
                    value: 0,
                    accessKey: ''
                };
                
                // Tentar extrair a chave de acesso
                const chaveMatch = qrData.match(/chNFe=([0-9]{44})/);
                if (chaveMatch) {
                    extractedData.accessKey = chaveMatch[1];
                }
                
                // Se for uma URL de NFe
                if (qrData.includes('nfce') || qrData.includes('NFe')) {
                    // Extrair informa√ß√µes da URL se poss√≠vel
                    const urlParams = new URLSearchParams(qrData.split('?')[1] || '');
                    
                    // Tentar extrair valor
                    const valor = urlParams.get('vNF');
                    if (valor) {
                        extractedData.value = parseFloat(valor.replace(',', '.'));
                    }
                    
                    alert('QR Code detectado! Complete as informa√ß√µes da nota fiscal.');
                } else {
                    // QR Code n√£o reconhecido como NFe
                    alert('QR Code lido, mas n√£o parece ser uma nota fiscal. Complete as informa√ß√µes manualmente.');
                }
                
                showReceiptModal(extractedData);
                
            } catch (error) {
                console.error('Erro ao processar QR Code:', error);
                alert('Erro ao processar QR Code. Complete as informa√ß√µes manualmente.');
                showReceiptModal();
            }
        }

        // Modal de nota fiscal
        function showReceiptModal(data = {}) {
            document.getElementById('establishment').value = data.establishment || '';
            document.getElementById('date').value = data.date || new Date().toISOString().split('T')[0];
            document.getElementById('value').value = data.value || '';
            document.getElementById('category').value = data.category || 'Outros';
            document.getElementById('accessKey').value = data.accessKey || '';
            
            document.getElementById('receiptModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('receiptModal').style.display = 'none';
            document.getElementById('receiptForm').reset();
        }

        // Salvar nota fiscal
        document.getElementById('receiptForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const receipt = {
                id: Date.now(),
                establishment: document.getElementById('establishment').value,
                date: document.getElementById('date').value,
                value: parseFloat(document.getElementById('value').value),
                category: document.getElementById('category').value,
                accessKey: document.getElementById('accessKey').value,
                createdAt: new Date().toISOString()
            };
            
            receipts.push(receipt);
            localStorage.setItem('receipts', JSON.stringify(receipts));
            
            closeModal();
            renderReceipts();
            updateStats();
            updateCategoryFilter();
        });

        // Filtrar por m√™s
        function changeMonth(direction) {
            currentMonth.setMonth(currentMonth.getMonth() + direction);
            updateMonthDisplay();
            renderReceipts();
            updateStats();
        }

        function updateMonthDisplay() {
            const months = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                          'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            document.getElementById('currentMonth').textContent = 
                `${months[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;
        }

        // Filtrar por categoria
        function filterByCategory(category) {
            activeCategory = category;
            document.querySelectorAll('.category-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            event.target.classList.add('active');
            renderReceipts();
        }

        function updateCategoryFilter() {
            const usedCategories = [...new Set(receipts.map(r => r.category))];
            const filterHtml = `
                <div class="category-chip ${activeCategory === 'all' ? 'active' : ''}" onclick="filterByCategory('all')">Todas</div>
                ${usedCategories.map(cat => `
                    <div class="category-chip ${activeCategory === cat ? 'active' : ''}" onclick="filterByCategory('${cat}')">${cat}</div>
                `).join('')}
            `;
            document.getElementById('categoryFilter').innerHTML = filterHtml;
        }

        // Renderizar notas fiscais
        function renderReceipts() {
            const filteredReceipts = receipts.filter(receipt => {
                const receiptDate = new Date(receipt.date);
                const monthMatch = receiptDate.getMonth() === currentMonth.getMonth() && 
                                 receiptDate.getFullYear() === currentMonth.getFullYear();
                const categoryMatch = activeCategory === 'all' || receipt.category === activeCategory;
                return monthMatch && categoryMatch;
            });
            
            const listHtml = filteredReceipts.length === 0 ? `
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <p>Nenhuma nota fiscal encontrada</p>
                    <p>Toque no bot√£o acima para escanear</p>
                </div>
            ` : filteredReceipts.map(receipt => `
                <div class="receipt-card">
                    <div class="receipt-header">
                        <div>
                            <div class="receipt-title">${receipt.establishment}</div>
                            <div class="receipt-info">
                                <span>${formatDate(receipt.date)}</span>
                            </div>
                        </div>
                        <div class="receipt-value">R$ ${receipt.value.toFixed(2)}</div>
                    </div>
                    <div class="receipt-category">${receipt.category}</div>
                    <button class="delete-button" onclick="deleteReceipt(${receipt.id})">√ó</button>
                </div>
            `).join('');
            
            document.getElementById('receiptList').innerHTML = listHtml;
        }

        // Atualizar estat√≠sticas
        function updateStats() {
            const monthReceipts = receipts.filter(receipt => {
                const receiptDate = new Date(receipt.date);
                return receiptDate.getMonth() === currentMonth.getMonth() && 
                       receiptDate.getFullYear() === currentMonth.getFullYear();
            });
            
            const total = monthReceipts.reduce((sum, receipt) => sum + receipt.value, 0);
            const count = monthReceipts.length;
            
            document.getElementById('monthTotal').textContent = `R$ ${total.toFixed(2)}`;
            document.getElementById('receiptCount').textContent = count;
        }

        // Excluir nota fiscal
        function deleteReceipt(id) {
            if (confirm('Deseja excluir esta nota fiscal?')) {
                receipts = receipts.filter(r => r.id !== id);
                localStorage.setItem('receipts', JSON.stringify(receipts));
                renderReceipts();
                updateStats();
                updateCategoryFilter();
            }
        }

        // Exportar para PDF
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const monthReceipts = receipts.filter(receipt => {
                const receiptDate = new Date(receipt.date);
                return receiptDate.getMonth() === currentMonth.getMonth() && 
                       receiptDate.getFullYear() === currentMonth.getFullYear();
            });
            
            // T√≠tulo
            doc.setFontSize(20);
            doc.text('Relat√≥rio de Notas Fiscais', 20, 20);
            
            // Per√≠odo
            doc.setFontSize(12);
            doc.text(document.getElementById('currentMonth').textContent, 20, 30);
            
            // Estat√≠sticas
            doc.setFontSize(14);
            doc.text('Resumo:', 20, 45);
            doc.setFontSize(12);
            doc.text(`Total: ${document.getElementById('monthTotal').textContent}`, 20, 55);
            doc.text(`Quantidade: ${document.getElementById('receiptCount').textContent}`, 20, 65);
            
            // Notas fiscais
            doc.setFontSize(14);
            doc.text('Notas Fiscais:', 20, 80);
            doc.setFontSize(10);
            
            let y = 90;
            monthReceipts.forEach(receipt => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.text(`${receipt.establishment} - ${formatDate(receipt.date)}`, 20, y);
                doc.text(`Categoria: ${receipt.category}`, 20, y + 5);
                doc.text(`Valor: R$ ${receipt.value.toFixed(2)}`, 20, y + 10);
                doc.line(20, y + 15, 190, y + 15);
                y += 20;
            });
            
            // Salvar PDF
            doc.save(`notas-fiscais-${currentMonth.getMonth() + 1}-${currentMonth.getFullYear()}.pdf`);
        }

        // Formatar data
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        // Inicializar quando a p√°gina carregar
        init();
    </script>
</body>
</html>
